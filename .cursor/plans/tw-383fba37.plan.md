<!-- 383fba37-3975-4bf7-bb03-48e30878cca6 fe68c774-c471-409a-ad12-0625423fa05c -->
# Plan: TW Scoring Project Structure Map

## 1. Objectives & Output Definition

- **Clarify goals**: The structure map should be the **single, high-level overview** of TW Scoring: domains, modules, key files, and how data/events flow between them.
- **Define document shape** for `.cursor/project-structure.md`:
- Short **overview** of the app (Electron main + Vue renderer + Node services + TCP/UDP + timers).
- **Directory tree** (trimmed to relevant code dirs) with annotations.
- **Domain sections** (competition, scoring, timing, terminals, protocols, licensing, etc.) each with:
  - Purpose & responsibilities
  - Key Vue components, Vuex modules, domain classes
  - Main-process pieces and external interfaces
- **Data-flow & event-flow summaries** for critical paths (scoring, timing, persistence, licensing).
- **Decide granularity**: Only list files that are:
- entry points, domain models, Vuex modules, or critical UI/servers
- helpers/protocol handlers that define external contracts.

## 2. Global Inventory & Baseline Mapping

- **Re-scan top-level layout** using `list_dir` to confirm current state (in case of branch drift since last snapshot):
- `src/main/`, `src/renderer/`, `events/`, `app_assets/`, `dist/`, `build/`, `_rules/`.
- **Identify primary entry points** and record them in the map draft:
- Electron main: `src/main/index.js`, `src/main/index.dev.js`.
- Renderer bootstrap: `src/renderer/main.js`, `src/renderer/App.vue`.
- Routing: `src/renderer/router/index.js`.
- State root: `src/renderer/store/index.js` + `store/modules/*`.
- Domain models: `src/renderer/classes/*`.
- **Cross-check with existing analysis docs**:
- `TW_SCORING_PROJECT_ANALYSIS.md`
- `TW_SCORING_MULTI_AGENT_PROMPT.md`
- Updated `_rules/*.mdc` files
- **Draft the top-level section** of `.cursor/project-structure.md`:
- 1–2 paragraphs summarizing architecture.
- A concise, annotated directory tree focusing on `src/`, `events/`, `app_assets/`, and build/runtime outputs.

## 3. Domain-Oriented Deep Dives

### 3.1 Main Process & Servers Domain

- **Files to examine**:
- `src/main/index.js`, `src/main/index.dev.js`
- `src/main/socket_setup.js`
- `src/main/server_competition.js`
- `src/main/TCPServer/*`
- `src/main/timingServer/timingDeviceServerSetup.js`
- `src/main/UDPServer/*` (even if partially unused)
- `src/main/lic_server.js`, `src/main/mobileServer/mobileServerSetup.js`
- **Goals**:
- Map responsibilities: window lifecycle, IPC channels, Socket.IO server, TCP judge server, timer integration, optional UDP.
- Enumerate key **IPC channels** and **Socket.IO events** (names + directions) at a high level.
- Note how `competition` state in `server_competition.js` is updated and broadcast.
- **Output in structure doc**:
- A “Main Process & Servers” section listing each submodule, brief role, and key event contracts.
- Short bullet mapping: *“Event X from renderer → IPC channel Y → handler Z.js → updates A → (optionally) emits Socket.IO event B”*.

### 3.2 Renderer Shell, Routing & Layout Domain

- **Files to examine**:
- `src/renderer/main.js`, `src/renderer/App.vue`
- `src/renderer/router/index.js`
- Layout components: `src/renderer/components/layout/*`
- Global UI helpers: `components/appComponents/*`, `components/ui/*`
- **Goals**:
- Capture how the **shell** is composed (header, menu, router-view, footer, info messages).
- Map **routes** to **pages/components** and to **high-level workflows** (licencing, competition setup, competitors, races, scoring, protocols, etc.).
- Show how global panels (timing settings, live services, language selector) plug into the header.
- **Output in structure doc**:
- A “Renderer Shell & Navigation” section with:
  - List of routes and their primary components.
  - Short explanation of each page’s responsibility.
  - Diagram-like bullets for global layout and cross-page overlays.

### 3.3 State Management (Vuex) Domain

- **Files to examine**:
- `src/renderer/store/index.js`
- All `src/renderer/store/modules/*.js`
- `src/renderer/store/constants.js` if used as shared constants.
- **Goals**:
- For each module (`main`, `timing`, `terminalsUdpService`, `message_system`, `protocols`, `protocol_settings`, `scoring_services`, `localization`, `key`, disciplines), document:
  - What **state** it owns.
  - Key **getters** (conceptually, not every one-by-one unless critical).
  - Representative **actions/mutations** and external event hookups (IPC, Socket.IO, EventBus).
- Identify any cross-module dependencies (e.g. `timing` depending on `main/competition`).
- **Output in structure doc**:
- A “State Management (Vuex Modules)” section with a table / bullets per module:
  - `Module name → Domain → Key state → Key external inputs (events) → Primary dependents (components/classes).`

### 3.4 Domain Models & Business Logic

- **Files to examine**:
- `src/renderer/classes/*` (Event, Race, Timer, Competitor, Judge, Team, DM/SX specific classes, Protocol classes, EventBus).
- **Goals**:
- For each major class, capture:
  - High-level purpose (1–2 sentences).
  - Important relationships (e.g. EventClass owns races, competitors, judges; RaceClass holds runs; TimerClass coordinates channels 1/3/4 for MO/DM, etc.).
  - Any notable, domain-specific invariants exposed by methods.
- Link classes back to Vuex modules and components that drive them.
- **Output in structure doc**:
- A “Domain Models” section with a table/outline:
  - `Class → Owned entities → Key responsibilities → Used by`.

### 3.5 Competition, Competitors, Races & Scoring UI

- **Files to examine**:
- Competition settings: `components/competitionSettings/*`
- Competitors: `components/competitors/*`, `pages/AthletesPage.vue`
- Races: `components/raceList/*`, `pages/RacesListPage.vue`
- Scoring: `components/scoring/*`, `pages/CompetitionControlPage.vue`
- **Goals**:
- For each subdomain, identify how **UI ↔ Vuex ↔ domain classes** are wired.
- Capture any key views (e.g. start lists, on-track competitor panels, scoring grids, finish tables) and where their data comes from.
- **Output in structure doc**:
- Per-subdomain subsections under “Competition & Scoring UI” documenting:
  - Primary components and views.
  - Vuex modules and classes backing them.
  - Critical actions/events (set race, set mark, accept result, etc.).

### 3.6 Terminals & Timing Devices

- **Files to examine**:
- Terminals: `src/main/TCPServer/*`, `src/renderer/utils/terminals-utils.js`, `store/modules/terminalsUdpService.js`, any scoring components that consume terminal events.
- Timing devices: `src/main/timingServer/timingDeviceServerSetup.js`, `store/modules/timing.js`, `classes/TimerClass.js`, `components/timing/*`.
- **Goals**:
- Map the end-to-end **terminal mark** flow and **result accepted** flow.
- Map the end-to-end **timer** flow: TCP message → IPC → EventBus/Vuex → UI and stored time records.
- **Output in structure doc**:
- A “Terminals & Timing” section with two subsections:
  - “Judge Terminals”: event paths, key message types, where they terminate in UI.
  - “Timing Devices”: connection lifecycle, `connectedDevices`, time sync flow, per-discipline timing modes.

### 3.7 Protocols, Exports & External Formats

- **Files to examine**:
- Protocol builder & templates: `renderer/components/protocol*`, `renderer/protocolHandlers/*`, `renderer/configs/protocol-builder-config.js`, protocol-related Vuex modules.
- Exports: XML FIS export in `main`/`store/modules/main.js` (`xml_export`), PDF/HTML/CSV/Excel utilities.
- **Goals**:
- Identify how protocol elements are modelled (Protocol* classes) and configured via Vuex.
- Map export workflows (who triggers them, what data is assembled, where outputs go on disk).
- **Output in structure doc**:
- A “Protocols & Exports” section, listing:
  - Protocol builder stack.
  - Standard exports (PDF, CSV, XML FIS, etc.) with brief notes on source data and output location.

### 3.8 Licensing, Keys, Localization & Live Services

- **Files to examine**:
- Licensing: `src/main/lic_server.js`, `renderer/components/licCheck.vue`, `store/modules/key.js`.
- Localization: `store/modules/localization.js` and any localization data.
- Live services: `store/modules/scoring_services.js`, any `live-service` components.
- **Goals**:
- Capture how licence checks gate the app (`router.beforeEach`, IPC for system data, license JSON file location).
- Document how localization data is structured and applied to UI.
- Briefly outline live service configuration and how it hooks into scoring.
- **Output in structure doc**:
- “Licensing & Security” and “Localization & Live Services” sections, each summarizing responsibilities, key modules, and external dependencies (systeminformation, licence files, live APIs).

## 4. Data-Flow & Event-Flow Narratives

- **Select 3–5 critical flows** to describe in textual diagrams:
- Judge scoring flow (terminal → main TCP server → IPC → Vuex → UI → Socket.IO broadcast).
- Timer event flow (timer TCP → IPC → EventBus/Vuex → TimerClass → MO/DM handling → UI & time records).
- Competition persistence (.twe) flow (save/load from header and menus → Vuex → file system).
- Protocol export flow (UI triggers → Vuex → protocol builder/handlers → file output).
- Licensing flow (app start/licCheck route → IPC for system data & licence file → Vuex `key` module → router guard).
- **For each flow**, write a concise step-by-step bullet chain:
- `Source → transport (IPC/Socket/TCP) → handler(s) → state updates (Vuex/domain objects) → UI / export side effect`.
- **Integrate these narratives into `.cursor/project-structure.md`** after the domain descriptions to give readers a mental model of runtime behaviour.

## 5. Consistency Check & Gap Identification

- **Cross-validate** the resulting map against:
- Actual directories/files (via `list_dir` / `glob_file_search`).
- `TW_SCORING_PROJECT_ANALYSIS.md` and `_rules/*.mdc`.
- **Identify gaps**:
- Domains with unclear ownership (e.g. legacy UDP pieces).
- Areas where state seems duplicated or responsibilities blurred.
- **Mark open questions/TODOs** inside the structure doc:
- Clearly label sections as `TODO` or `Needs refinement` where code is ambiguous or refactor is pending.

## 6. Document Structure & Maintenance Guidelines

- **Finalize `.cursor/project-structure.md` layout**:
- `Overview` → `Annotated directory tree` → `Domains` → `Data/Event flows` → `Gaps & TODOs` → `Update guidelines`.
- **Write a short “How to maintain this map” section**:
- When adding a new module or domain, what needs updating (domain section, directory tree, flows if affected).
- Convention for link formatting and referencing files (paths relative to repo root).
- **Optionally link** from this doc to `_rules/*.mdc` so future work naturally follows both the rules and the structure map.

### To-dos

- [ ] Re-scan top-level project layout and key entry points, then draft overview and annotated directory tree in .cursor/project-structure.md.
- [ ] Map main-process and server responsibilities (Electron main, Socket.IO, TCP/UDP terminals, timing server, licence server) and record them in a dedicated section.
- [ ] Document renderer shell, routing, and layout (App.vue, router, layout components, global panels).
- [ ] Catalogue Vuex modules and domain classes, describing owned state, responsibilities, and cross-dependencies.
- [ ] Describe competition, competitors, races, and scoring UI domains with their key components and state flows.
- [ ] Trace and document full flows for judge terminals and timing devices from TCP to UI and persistence.
- [ ] Document protocol builder, templates, and export workflows (PDF/CSV/XML FIS, etc.).
- [ ] Write narrative data/event-flow sections for core paths and perform a consistency/gap review against code and analysis docs.